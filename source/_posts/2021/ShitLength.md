---
title: 由一坨屎的长度引发的思考
date: 2021-05-26
tags: [iOS]
---

## 始
OC里
```objc
[@"💩" length]
```
屎的长度为2

而Swift中
```swift
"💩".count
```
屎的长度为1

到底是为什么，屎的长度会不一样？难道苹果暗示OC比Swift更💩吗，这一切的背后到底是道德的沦丧，还是人性的扭曲，~~欢迎走进道德观察栏目~~

其实，OC里的字符串长度是以uft16来计算的，💩的unicode十进制为128169，16进制为0x1F4A9，2进制长度17位，需要用到2个uft16单元来显示，而Swift里的长度是真正意义上的长度

## 其一

unicode（统一码、唯一码）的本意是为世界上的每一个字符都配上一个整数，截至2020年3月，Unicode最新版本13.0，已收录超过14万个字符。unicode使用21bit来表示，最大有效位为10FFFF，理论可收录110多万个字符，目前使用率只有12%左右，所以大部分的位置都是空白的，而且并不是连续的，因此你随机给一个unicode数去找对应的符号会出现找不到的情况。

## 其二

unicode只是一个字符的规则集合，规定了这个字符是什么代码，但没规定他要怎么存，于是出现了下列的编码方式
### utf-32
直接用固定的32位空间去存unicode，显然，对大部分字符来说是非常浪费的

### utf-16
使用1～2个即2～4byte的动态空间去存，比固定的32位要好得多，但这仍然不够

### uft-8
每个字符可用1～4个byte来表示，更加的高效
对于abc这些字母来说，一个byte就可以了，具体的编码规则有兴趣的可以自己去探索

## 其三

在对字符串做凯撒加密后发现解密无法复原，经过一番调查，加密后字符串长度变短了，而由于加解密的算法中有文本长度作为变量因子，因此出现解密后乱码情况。到底是谁，加密之后消失了？

在对字符串逐个打印的时候发现了一个现象，一个空字符串它的长度居然不为零？它的unicode为U+200B
没错，他就是零宽度字符家族的一员，其系列主要有
- U+200B：零宽度空格符
- U+200C：零宽度断字符
- U+200D：零宽度连字符
- U+200E：左至右符
- U+200F：右至左符
- U+FEFF：零宽度非断空格符

这里的零宽度空格符主要是用来换行用的，由于加密时没有做特殊处理，加密后变成了真·空字符串（长度0）。

## 其四

在对某些emoji做凯撒加密也发现无法解密复原，在排除💩之2的坑以后发现，某些emoji由多个unicode组成（unicodeScalars），有1、2、4、5个unicode组成的情况。我们称之为组合字符。

以这个emoji为例：👱🏻‍♀️

它共有5个unicode组成
十进制分别为：128113, 127995, 8205, 9792, 65039
十六进制分别为：1F471, 1F3FB, 200D, 2640, FE0F

分别代表以下各自含义
- 1F471：👱 金色头发的人
- 1F3FB：较浅肤色
- 200D：零宽度连接符
- 2640：♀ 女性符号
- FE0F：变体选择符-16

可以大致推导：

👱🏻（金色头发的人: 较浅肤色）= 👱（金色头发的人）+ 较浅肤色

👱🏻‍♀️（女人：浅肤色，金色的头发）= 👱🏻 + ♀

注：最后的变体选择符，指定前面的字符应以Emoji样式显示，这里将前面的 ♀ 文本符号变成emoji，再通过 零宽度连接符 和前面的emoji（金色头发的人: 较浅肤色）合并

另外，emoji不同平台展示也是不一样的

<img src="/images/2021/ShitLength/emoji.jpg">

## 末

没想到一坨屎的长度能够引出这么多的思考，~~其实是凯撒加密踩出来的坑~~，上面提到的只是unicode的冰山一角，内容之多坑之深，有兴趣的可以去更深入的挖掘。

